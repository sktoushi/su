<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Repository Issue Randomizer (Crypto RNG, No Loop)</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #fafafa;
      margin: 2rem;
    }
    code {
      background: #eee;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
    }
    a { word-break: break-all; }
  </style>
</head>
<body>

<script>
/* ============================================================
   Crypto-secure randomness only (no Math.random)
   Steps:
   1) Load config/all.json
   2) Extract a single repository entry (final repositories object)
   3) Pick a random issue in [Math.max(1, end - 100), end] using crypto RNG
   4) Redirect immediately to the chosen issue URL
   ============================================================ */

(function () {
  const TWO32 = 0x100000000; // 2^32

  function assertCrypto() {
    if (!window.crypto || !window.crypto.getRandomValues) {
      throw new Error('Secure RNG unavailable: window.crypto.getRandomValues not found.');
    }
  }

  // Uniform float in [0, 1)
  function cryptoRandomFloat() {
    assertCrypto();
    const buf = new Uint32Array(1);
    window.crypto.getRandomValues(buf);
    return buf[0] / TWO32;
  }

  // Uniform integer in [min, max] without modulo bias (rejection sampling)
  function cryptoRandomInt(min, max) {
    assertCrypto();
    if (!Number.isInteger(min) || !Number.isInteger(max) || max < min) {
      throw new Error('Invalid range for cryptoRandomInt.');
    }
    const range = max - min + 1;
    // Largest multiple of range less than 2^32
    const limit = TWO32 - (TWO32 % range);
    const buf = new Uint32Array(1);
    let x;
    do {
      window.crypto.getRandomValues(buf);
      x = buf[0];
    } while (x >= limit);
    return min + (x % range);
  }

  function extractFinalRepo(repositories) {
    if (!repositories || typeof repositories !== 'object') {
      throw new Error('Invalid repositories structure in config.');
    }

    // Case A: already a single final object: { repo, username, issueEndNumber }
    if ('repo' in repositories && 'username' in repositories && 'issueEndNumber' in repositories) {
      return {
        repo: String(repositories.repo),
        username: String(repositories.username),
        issueEndNumber: Number(repositories.issueEndNumber)
      };
    }

    // Case B: a mapping of repoName -> info. Choose one entry securely at random.
    const entries = Object.entries(repositories);
    if (entries.length === 0) throw new Error('No repositories configured.');

    const rndIdx = cryptoRandomInt(0, entries.length - 1);
    const [repoName, info] = entries[rndIdx];

    if (!info || typeof info !== 'object') throw new Error('Malformed repository info.');
    if (!info.username) throw new Error('Missing "username" in repository info.');
    if (info.issueEndNumber == null) throw new Error('Missing "issueEndNumber" in repository info.');

    return {
      repo: String(repoName),
      username: String(info.username),
      issueEndNumber: Number(info.issueEndNumber)
    };
  }

  async function main() {
    const res = await fetch('config/all.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load config');
    const cfg = await res.json();

    const reposRaw = cfg.repositories || cfg.repository || cfg.repo || {};
    const finalRepo = extractFinalRepo(reposRaw);

    const end = Number(finalRepo.issueEndNumber);
    if (!Number.isFinite(end) || end < 1) throw new Error('Invalid issueEndNumber.');

    const lowerBound = Math.max(1, end - 100);
    const randomChosenNumber = cryptoRandomInt(lowerBound, end);

    const user = finalRepo.username;
    const repo = finalRepo.repo;
    const chosenUrl = `https://github.com/${user}/${repo}/issues/${randomChosenNumber}`;

    // Redirect immediately
    location.href = chosenUrl;

    // Fallback UI if redirect is blocked
    document.addEventListener('DOMContentLoaded', () => {
      const wrap = document.createElement('div');
      const h = document.createElement('h2');
      h.textContent = 'Redirecting to a random issueâ€¦';
      const p = document.createElement('p');
      p.innerHTML = `Selected range: <code>[${lowerBound}, ${end}]</code><br/>
                     Chosen issue: <code>#${randomChosenNumber}</code><br/>
                     Repository: <code>${user}/${repo}</code><br/>
                     Link: <a href="${chosenUrl}">${chosenUrl}</a>`;
      wrap.appendChild(h);
      wrap.appendChild(p);
      document.body.appendChild(wrap);
    });
  }

  main().catch(err => {
    document.body.textContent = err.message;
  });
})();
</script>

</body>
</html>
