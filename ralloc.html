<!DOCTYPE html>
<html lang="en">
<head>
    <script src="common/history-utils.js"></script>
    <script src="common/random-utils.js"></script>
    <meta charset="UTF-8">
    <title>Ralloc</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Include Chart.js for bar graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS for styling -->
    <style>
        body {
            padding: 20px;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
        }
        .frequency-label {
            margin-left: 10px;
        }
        .frequency-slider {
            width: 100%;
        }
        @media (max-width: 576px) {
            .frequency-label {
                display: block;
                margin-top: 5px;
            }
        }
        textarea.record-link, input.record-name, input.record-tags {
            width: 100%;
            resize: vertical;
        }
        .record-tags {
            width: 100%;
        }
        .record-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        #controls-row, #additional-controls-row, #third-controls-row, #bulk-actions-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        #rollBtn {
            margin-left: 10px;
        }
        .top-records-percentage {
            font-weight: bold;
        }
        #topRecordsContainer {
            display: none; /* Hidden by default */
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        /* Configuration section styles */
        #configuration-section {
            margin-top: 30px;
        }
        #editDestinationBtn {
            margin-left: 10px;
        }
        /* Styles for third row buttons */
        #third-controls-row .btn {
            width: 160px; /* Reduced width from 180px to 160px */
            height: 70px; /* Reduced height from 80px to 70px */
            font-size: 1.3rem; /* Reduced font-size from 1.5rem to 1.3rem */
            padding: 15px; /* Reduced padding from 20px to 15px */
            white-space: nowrap; /* Prevent text from wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis (...) for overflow */
        }
        @media (max-width: 576px) {
            #third-controls-row .btn {
                width: 130px; /* Adjusted width for smaller screens */
                height: 55px; /* Adjusted height for smaller screens */
                font-size: 1.1rem; /* Adjusted font-size for smaller screens */
                padding: 10px; /* Adjusted padding for smaller screens */
            }
        }
        /* Styles for enhanced lottery animation */
        #lotteryAnimation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px; /* Increased size from 300px to 400px */
            height: 400px; /* Increased size from 300px to 400px */
            background: url('lottery-bg.png') no-repeat center center;
            background-size: cover;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 3000;
            animation: fadeIn 0.5s forwards;
        }
        #lotteryAnimation.show {
            display: flex;
            animation: fadeIn 0.5s forwards;
        }
        #lotteryAnimation.hide {
            animation: fadeOut 0.5s forwards;
        }
        #lotteryAnimation .static-image {
            width: 150px; /* Increased size from 100px to 150px */
            height: 150px; /* Increased size from 100px to 150px */
            background: url('spinner.gif') no-repeat center center;
            background-size: contain;
            /* Removed spinning animation */
        }
        #lotteryAnimation .record-name {
            margin-top: 30px; /* Increased margin-top from 20px to 30px */
            color: #fff;
            font-size: 1.8rem; /* Increased font-size from 1.5rem to 1.8rem */
            text-align: center;
            word-wrap: break-word;
            text-shadow: 2px 2px 4px #000;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        /* Overlay to prevent interactions during animation */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2500;
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        body.dark-mode .table {
            color: #ffffff;
        }
        body.dark-mode .table thead {
            background-color: #1f1f1f;
        }
        body.dark-mode .btn-primary {
            background-color: #3a3a3a;
            border-color: #3a3a3a;
        }
        body.dark-mode .btn-secondary {
            background-color: #5a5a5a;
            border-color: #5a5a5a;
        }
        body.dark-mode .btn-info {
            background-color: #007bff;
            border-color: #007bff;
        }
        body.dark-mode .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
        }
        body.dark-mode .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        /* Tooltip styles */
        .tooltip-inner {
            max-width: 200px;
            /* Adjust as needed */
        }
        /* Gamification Section Styles */
        #gamification-section {
            margin-bottom: 30px;
        }
        #levelDisplay {
            font-size: 1.5rem;
            font-weight: bold;
        }
        #progressBarContainer {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-center">Ralloc</h1>
            <!-- Dark Mode Toggle -->
            <div class="form-group mb-0">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="darkModeToggle">
                    <label class="custom-control-label" for="darkModeToggle">Dark Mode</label>
                </div>
            </div>
        </div>

        <!-- Gamification Section -->
        <div id="gamification-section" class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div id="levelDisplay">Level: 1</div>
                <div id="rollsDisplay">Total Rolls: 0</div>
            </div>
            <div id="progressBarContainer">
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small id="progressText">0 rolls until next level</small>
            </div>
        </div>

        <!-- Slider for Review/Generator split -->
        <div class="slider-label">
            <span>Review</span>
            <span>Generator</span>
        </div>
        <input type="range" class="custom-range" id="typeSlider" min="0" max="100" value="66" aria-label="Review Generator Slider">
        <div class="text-center">
            <span id="sliderValue">66% Review / 34% Generator</span>
        </div>
        <br>
        <!-- Search and Filter -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchBar" class="form-control" placeholder="Search records by name or type" aria-label="Search Records">
            </div>
            <div class="col-md-6 text-right">
                <!-- Bulk Actions -->
                <div id="bulk-actions-row">
                    <button class="btn btn-danger" id="bulkDeleteBtn" data-toggle="tooltip" data-placement="top" title="Delete selected records">
                        Bulk Delete
                    </button>
                </div>
            </div>
        </div>
        <!-- Buttons for state management -->
        <div id="controls-row">
            <button class="btn btn-primary" id="importStateBtn" data-toggle="tooltip" data-placement="top" title="Import state from a JSON file">Import State</button>
            <button class="btn btn-primary" id="exportStateBtn" data-toggle="tooltip" data-placement="top" title="Export current state to a JSON file">Export State</button>
            <button class="btn btn-danger" id="resetStateBtn" data-toggle="tooltip" data-placement="top" title="Reset all data to default">Reset State</button>
            <button class="btn btn-secondary" id="addRecordBtn" data-toggle="tooltip" data-placement="top" title="Add a new record">Add Record</button>
        </div>
        <!-- Additional algorithm buttons -->
        <div id="additional-controls-row">
            <button class="btn btn-info" id="smootheningBtn" data-toggle="tooltip" data-placement="top" title="Adjust frequencies based on total picks">Smoothening</button>
            <button class="btn btn-info" id="solidifyingBtn" data-toggle="tooltip" data-placement="top" title="Increase frequency of records with fewer Generator picks">Solidifying</button>
            <button class="btn btn-info" id="reviewingBtn" data-toggle="tooltip" data-placement="top" title="Focus on records with the most Review picks">Reviewing</button>
            <button class="btn btn-info" id="exploringBtn" data-toggle="tooltip" data-placement="top" title="Focus on new or least picked records">Exploring</button>
            <button class="btn btn-info" id="spacedRepetitionBtn" data-toggle="tooltip" data-placement="top" title="Implement spaced repetition for better retention">Spaced Repetition</button>
            <button class="btn btn-info" id="focusWeakestBtn" data-toggle="tooltip" data-placement="top" title="Focus on records with the fewest total picks">Focus Weakest</button>
        </div>
        <!-- Third row for Randomizing and Roll buttons -->
        <div id="third-controls-row">
            <button class="btn btn-warning" id="randomizingBtn" data-toggle="tooltip" data-placement="top" title="Randomize frequencies and selections">Randomizing</button>
            <button class="btn btn-success" id="rollBtn" data-toggle="tooltip" data-placement="top" title="Roll to select a record">Roll</button>
        </div>
        <input type="file" id="importFileInput" accept="application/json" style="display: none;">
        <br>
        <!-- Table of records -->
        <table class="table table-bordered" id="recordsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllCheckbox" aria-label="Select All Records"></th>
                    <th>Visit Link</th>
                    <th>Record Name</th>
                    <th>Link</th>
                    <th>Type</th>
                    <th>Frequency</th>
                    <th>Tags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody">
                <!-- Records will be dynamically added here -->
            </tbody>
        </table>
        <br>
        <!-- Top 10 Most-Picked Records -->
        <div id="topRecordsContainer">
            <h3>Top 10 Most-Picked Records</h3>
            <!-- Bar Graph -->
            <div class="chart-container">
                <canvas id="topRecordsChart"></canvas>
            </div>
            <!-- Historical reference text -->
            <div id="historicalReferenceText">
                <!-- Text will be dynamically added here -->
            </div>
            <ol id="topRecordsList">
                <!-- Top records will be dynamically added here -->
            </ol>
        </div>
        <!-- Configuration Section -->
        <div id="configuration-section">
            <h3>Configuration</h3>
            <div class="form-group">
                <label for="storageDestination">State Storage Destination:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="storageDestination" disabled aria-label="State Storage Destination">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="editDestinationBtn" data-toggle="tooltip" data-placement="top" title="Edit storage destination">Edit</button>
                        <button class="btn btn-outline-secondary" id="saveDestinationBtn" style="display: none;" data-toggle="tooltip" data-placement="top" title="Save storage destination">Save</button>
                        <button class="btn btn-outline-secondary" id="cancelDestinationBtn" style="display: none;" data-toggle="tooltip" data-placement="top" title="Cancel editing storage destination">Cancel</button>
                    </div>
                </div>
                <small class="form-text text-muted">
                    This value will be the destination page upon clicking the <strong>Export State</strong> button after the JSON file has been downloaded.
                </small>
            </div>
        </div>
    </div>

    <!-- Lottery Animation Overlay -->
    <div id="overlay"></div>
    <div id="lotteryAnimation">
        <div class="static-image"></div>
        <div class="record-name" id="animationRecordName"></div>
    </div>

    <!-- Include necessary scripts -->
    <!-- Include jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Popper and Bootstrap JS for Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Custom JavaScript -->
    <script>


        $(document).ready(function() {
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();

            // Global variables
            let totalRolls = 0;
            let totalReviewRolls = 0;
            let totalGeneratorRolls = 0;
            let topRecordsChart;
            let defaultStorageDestination = "https://github.com/sktoushi/stash-utils/upload/main";

            // Gamification Variables
            let userLevel = 1;
            let rollsForNextLevel = calculateRollsForNextLevel(userLevel);

            // Dark Mode Toggle Handler
            $('#darkModeToggle').change(function() {
                $('body').toggleClass('dark-mode');
                // Save preference
                let darkMode = $(this).is(':checked');
                localStorage.setItem('rallocDarkMode', darkMode);
            });

            // Load Dark Mode preference
            if (localStorage.getItem('rallocDarkMode') === 'true') {
                $('body').addClass('dark-mode');
                $('#darkModeToggle').prop('checked', true);
            }

            // Update slider value display
            $('#typeSlider').on('input change', function() {
                let reviewPercent = $(this).val();
                let generatorPercent = 100 - reviewPercent;
                $('#sliderValue').text(reviewPercent + '% Review / ' + generatorPercent + '% Generator');
                // Save to LocalStorage
                let data = getCurrentData();
                localStorage.setItem('rallocStorageKey', JSON.stringify(data));
            });

            // Load data from LocalStorage or ralloc-state.json
            function loadData() {
                let data = localStorage.getItem('rallocStorageKey');
                if (data) {
                    data = JSON.parse(data);
                    totalRolls = data.totalRolls || 0;
                    totalReviewRolls = data.totalReviewRolls || 0;
                    totalGeneratorRolls = data.totalGeneratorRolls || 0;
                    userLevel = data.userLevel || 1;
                    rollsForNextLevel = calculateRollsForNextLevel(userLevel);
                    // Use the data
                    $('#typeSlider').val(data.sliderValue || 66);
                    $('#typeSlider').trigger('change');
                    populateRecords(data.records);
                    populateTopRecords(data.topRecords);
                    // Load storage destination
                    $('#storageDestination').val(data.storageDestination || defaultStorageDestination);
                    // Update gamification UI
                    updateGamificationUI();
                } else {
                    // Try to fetch ralloc-state.json
                    $.ajax({
                        url: 'ralloc-state.json',
                        dataType: 'json',
                        success: function(jsonData) {
                            // Store in LocalStorage
                            localStorage.setItem('rallocStorageKey', JSON.stringify(jsonData));
                            totalRolls = jsonData.totalRolls || 0;
                            totalReviewRolls = jsonData.totalReviewRolls || 0;
                            totalGeneratorRolls = jsonData.totalGeneratorRolls || 0;
                            userLevel = jsonData.userLevel || 1;
                            rollsForNextLevel = calculateRollsForNextLevel(userLevel);
                            // Use the data
                            $('#typeSlider').val(jsonData.sliderValue || 66);
                            $('#typeSlider').trigger('change');
                            populateRecords(jsonData.records);
                            populateTopRecords(jsonData.topRecords);
                            // Load storage destination
                            $('#storageDestination').val(jsonData.storageDestination || defaultStorageDestination);
                            // Update gamification UI
                            updateGamificationUI();
                        },
                        error: function() {
                            // No data available, initialize empty data
                            let initialData = {
                                sliderValue: 66,
                                records: [],
                                topRecords: [],
                                totalRolls: 0,
                                totalReviewRolls: 0,
                                totalGeneratorRolls: 0,
                                userLevel: 1,
                                storageDestination: defaultStorageDestination
                            };
                            localStorage.setItem('rallocStorageKey', JSON.stringify(initialData));
                            $('#storageDestination').val(defaultStorageDestination);
                            // Update gamification UI
                            updateGamificationUI();
                        }
                    });
                }
            }

            loadData();

            // Function to create a record row
            function createRecordRow(record) {
                let row = $('<tr></tr>');
                let checkbox = $('<input type="checkbox" class="record-select">').prop('checked', record.selected).attr('aria-label', 'Select Record');
                let visitBtn = $('<button class="btn btn-link">Visit Link</button>');
                visitBtn.click(function() {
                    window.open(record.link, '_blank');
                });
                let nameInput = $('<input type="text" class="form-control record-name" required aria-label="Record Name">').val(record.name);
                let linkInput = $('<input type="url" class="form-control record-link" required aria-label="Record Link">').val(record.link);
                let typeSelect = $('<select class="form-control record-type" aria-label="Record Type"><option value="Review">Review</option><option value="Generator">Generator</option></select>').val(record.type);
                let frequencyInput = $('<input type="range" class="custom-range record-frequency" min="1" max="100" aria-label="Frequency Slider">').val(record.frequency || 1);
                let frequencyLabel = $('<span class="frequency-label">' + (record.frequency || 1) + '</span>');
                frequencyInput.on('input change', function() {
                    frequencyLabel.text($(this).val());
                });
                let frequencyCell = $('<td></td>').append(frequencyInput).append(frequencyLabel);
                let tagsInput = $('<input type="text" class="form-control record-tags" placeholder="e.g., math, science" aria-label="Record Tags">').val(record.tags || '');
                let deleteBtn = $('<button class="btn btn-danger btn-sm">Delete</button>');
                deleteBtn.click(function() {
                    if (confirm('Are you sure you want to delete this record?')) {
                        row.remove();
                        saveData();
                    }
                });
                let actionsCell = $('<td></td>').append(deleteBtn);

                row.append($('<td></td>').append(checkbox));
                row.append($('<td></td>').append(visitBtn));
                row.append($('<td></td>').append(nameInput));
                row.append($('<td></td>').append(linkInput));
                row.append($('<td></td>').append(typeSelect));
                row.append(frequencyCell);
                row.append($('<td></td>').append(tagsInput));
                row.append(actionsCell);
                row.data('recordId', record.id);
                return row;
            }

            // Function to populate records table
            function populateRecords(records) {
                $('#recordsTableBody').empty();
                if (!records) return;
                records.forEach(function(record) {
                    let row = createRecordRow(record);
                    $('#recordsTableBody').append(row);
                });
            }

            // Function to populate top records list and chart
            function populateTopRecords(topRecords) {
                if (totalRolls === 0) {
                    $('#topRecordsContainer').hide();
                    return;
                }
                $('#topRecordsContainer').show();
                $('#topRecordsList').empty();
                $('#historicalReferenceText').empty();
                if (!topRecords) return;
                // Sort topRecords by totalCount descending
                topRecords.sort(function(a, b) {
                    return b.totalCount - a.totalCount;
                });
                let labels = [];
                let reviewData = [];
                let generatorData = [];
                let historicalText = '';
                let totalReviewPercentage = ((totalReviewRolls / totalRolls) * 100).toFixed(2);
                let totalGeneratorPercentage = ((totalGeneratorRolls / totalRolls) * 100).toFixed(2);
                historicalText = '<p>Overall: ' + totalReviewPercentage + '% Review, ' + totalGeneratorPercentage + '% Generator</p>';
                $('#historicalReferenceText').html(historicalText);
                topRecords.slice(0, 10).forEach(function(recordStat) {
                    let record = getRecordById(recordStat.id);
                    if (record) {
                        let percentage = ((recordStat.totalCount / totalRolls) * 100).toFixed(2);
                        let listItem = $('<li></li>').append(
                            $('<strong>' + record.name + '</strong> - '),
                            $('<a href="' + record.link + '" target="_blank">' + record.link + '</a>'),
                            $('<span> - Picked: ' + recordStat.totalCount + ' times (' + percentage + '%)</span>').addClass('top-records-percentage')
                        );
                        $('#topRecordsList').append(listItem);
                        labels.push(record.name || 'Unnamed');
                        reviewData.push(recordStat.reviewCount || 0);
                        generatorData.push(recordStat.generatorCount || 0);
                    }
                });
                // Create or update the chart
                if (topRecordsChart) {
                    topRecordsChart.data.labels = labels;
                    topRecordsChart.data.datasets[0].data = reviewData;
                    topRecordsChart.data.datasets[1].data = generatorData;
                    topRecordsChart.update();
                } else {
                    let ctx = document.getElementById('topRecordsChart').getContext('2d');
                    topRecordsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Review',
                                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                    data: reviewData
                                },
                                {
                                    label: 'Generator',
                                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                                    data: generatorData
                                }
                            ]
                        },
                        options: {
                            scales: {
                                xAxes: [{
                                    stacked: true
                                }],
                                yAxes: [{
                                    stacked: true,
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }

            // Function to calculate rolls needed for next level
            function calculateRollsForNextLevel(level) {
                // Exponential growth: rolls needed = 100 * 2^(level-1)
                return 100 * Math.pow(2, level - 1);
            }

            // Function to update gamification UI
            function updateGamificationUI() {
                $('#levelDisplay').text('Level: ' + userLevel);
                $('#rollsDisplay').text('Total Rolls: ' + totalRolls);
                let rollsUntilNextLevel = rollsForNextLevel - (totalRolls % rollsForNextLevel);
                $('#progressText').text(rollsUntilNextLevel + ' rolls until next level');
                let progressPercentage = ((totalRolls % rollsForNextLevel) / rollsForNextLevel) * 100;
                $('#progressBar').css('width', progressPercentage + '%');
                $('#progressBar').attr('aria-valuenow', progressPercentage);
                $('#progressBar').text(Math.floor(progressPercentage) + '%');
            }

            // Function to create a record row
            function createRecordRow(record) {
                let row = $('<tr></tr>');
                let checkbox = $('<input type="checkbox" class="record-select">').prop('checked', record.selected).attr('aria-label', 'Select Record');
                let visitBtn = $('<button class="btn btn-link">Visit Link</button>');
                visitBtn.click(function() {
                    window.open(record.link, '_blank');
                });
                let nameInput = $('<input type="text" class="form-control record-name" required aria-label="Record Name">').val(record.name);
                let linkInput = $('<input type="url" class="form-control record-link" required aria-label="Record Link">').val(record.link);
                let typeSelect = $('<select class="form-control record-type" aria-label="Record Type"><option value="Review">Review</option><option value="Generator">Generator</option></select>').val(record.type);
                let frequencyInput = $('<input type="range" class="custom-range record-frequency" min="1" max="100" aria-label="Frequency Slider">').val(record.frequency || 1);
                let frequencyLabel = $('<span class="frequency-label">' + (record.frequency || 1) + '</span>');
                frequencyInput.on('input change', function() {
                    frequencyLabel.text($(this).val());
                });
                let frequencyCell = $('<td></td>').append(frequencyInput).append(frequencyLabel);
                let tagsInput = $('<input type="text" class="form-control record-tags" placeholder="e.g., math, science" aria-label="Record Tags">').val(record.tags || '');
                let deleteBtn = $('<button class="btn btn-danger btn-sm">Delete</button>');
                deleteBtn.click(function() {
                    if (confirm('Are you sure you want to delete this record?')) {
                        row.remove();
                        saveData();
                    }
                });
                let actionsCell = $('<td></td>').append(deleteBtn);

                row.append($('<td></td>').append(checkbox));
                row.append($('<td></td>').append(visitBtn));
                row.append($('<td></td>').append(nameInput));
                row.append($('<td></td>').append(linkInput));
                row.append($('<td></td>').append(typeSelect));
                row.append(frequencyCell);
                row.append($('<td></td>').append(tagsInput));
                row.append(actionsCell);
                row.data('recordId', record.id);
                return row;
            }

            // Function to populate records table
            function populateRecords(records) {
                $('#recordsTableBody').empty();
                if (!records) return;
                records.forEach(function(record) {
                    let row = createRecordRow(record);
                    $('#recordsTableBody').append(row);
                });
            }

            // Function to populate top records list and chart
            function populateTopRecords(topRecords) {
                if (totalRolls === 0) {
                    $('#topRecordsContainer').hide();
                    return;
                }
                $('#topRecordsContainer').show();
                $('#topRecordsList').empty();
                $('#historicalReferenceText').empty();
                if (!topRecords) return;
                // Sort topRecords by totalCount descending
                topRecords.sort(function(a, b) {
                    return b.totalCount - a.totalCount;
                });
                let labels = [];
                let reviewData = [];
                let generatorData = [];
                let historicalText = '';
                let totalReviewPercentage = ((totalReviewRolls / totalRolls) * 100).toFixed(2);
                let totalGeneratorPercentage = ((totalGeneratorRolls / totalRolls) * 100).toFixed(2);
                historicalText = '<p>Overall: ' + totalReviewPercentage + '% Review, ' + totalGeneratorPercentage + '% Generator</p>';
                $('#historicalReferenceText').html(historicalText);
                topRecords.slice(0, 10).forEach(function(recordStat) {
                    let record = getRecordById(recordStat.id);
                    if (record) {
                        let percentage = ((recordStat.totalCount / totalRolls) * 100).toFixed(2);
                        let listItem = $('<li></li>').append(
                            $('<strong>' + record.name + '</strong> - '),
                            $('<a href="' + record.link + '" target="_blank">' + record.link + '</a>'),
                            $('<span> - Picked: ' + recordStat.totalCount + ' times (' + percentage + '%)</span>').addClass('top-records-percentage')
                        );
                        $('#topRecordsList').append(listItem);
                        labels.push(record.name || 'Unnamed');
                        reviewData.push(recordStat.reviewCount || 0);
                        generatorData.push(recordStat.generatorCount || 0);
                    }
                });
                // Create or update the chart
                if (topRecordsChart) {
                    topRecordsChart.data.labels = labels;
                    topRecordsChart.data.datasets[0].data = reviewData;
                    topRecordsChart.data.datasets[1].data = generatorData;
                    topRecordsChart.update();
                } else {
                    let ctx = document.getElementById('topRecordsChart').getContext('2d');
                    topRecordsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Review',
                                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                    data: reviewData
                                },
                                {
                                    label: 'Generator',
                                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                                    data: generatorData
                                }
                            ]
                        },
                        options: {
                            scales: {
                                xAxes: [{
                                    stacked: true
                                }],
                                yAxes: [{
                                    stacked: true,
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }

            // Function to calculate rolls needed for next level
            function calculateRollsForNextLevel(level) {
                // Exponential growth: rolls needed = 100 * 2^(level-1)
                return 100 * Math.pow(2, level - 1);
            }

            // Function to update gamification UI
            function updateGamificationUI() {
                $('#levelDisplay').text('Level: ' + userLevel);
                $('#rollsDisplay').text('Total Rolls: ' + totalRolls);
                let rollsUntilNextLevel = rollsForNextLevel - (totalRolls % rollsForNextLevel);
                $('#progressText').text(rollsUntilNextLevel + ' rolls until next level');
                let progressPercentage = ((totalRolls % rollsForNextLevel) / rollsForNextLevel) * 100;
                $('#progressBar').css('width', progressPercentage + '%');
                $('#progressBar').attr('aria-valuenow', progressPercentage);
                $('#progressBar').text(Math.floor(progressPercentage) + '%');
            }

            // Function to get current data
            function getCurrentData() {
                let data = {};
                data.sliderValue = parseInt($('#typeSlider').val());
                data.records = [];
                $('#recordsTableBody tr').each(function() {
                    let row = $(this);
                    let record = {
                        id: row.data('recordId'),
                        selected: row.find('.record-select').is(':checked'),
                        name: row.find('.record-name').val(),
                        link: row.find('.record-link').val(),
                        type: row.find('.record-type').val(),
                        frequency: parseInt(row.find('.record-frequency').val()),
                        tags: row.find('.record-tags').val(),
                        lastPicked: row.data('lastPicked') || null
                    };
                    data.records.push(record);
                });
                data.topRecords = JSON.parse(localStorage.getItem('rallocStorageKey') || '{}').topRecords || [];
                data.totalRolls = totalRolls;
                data.totalReviewRolls = totalReviewRolls;
                data.totalGeneratorRolls = totalGeneratorRolls;
                data.userLevel = userLevel;
                data.storageDestination = $('#storageDestination').val();
                return data;
            }

            // Save data when inputs change
            $('#recordsTableBody').on('change', 'input, select, textarea', function() {
                saveData();
            });

            function saveData() {
                let data = getCurrentData();
                localStorage.setItem('rallocStorageKey', JSON.stringify(data));
            }

            // Get record by ID
            function getRecordById(id) {
                let records = [];
                $('#recordsTableBody tr').each(function() {
                    let row = $(this);
                    if (row.data('recordId') === id) {
                        let record = {
                            id: row.data('recordId'),
                            selected: row.find('.record-select').is(':checked'),
                            name: row.find('.record-name').val(),
                            link: row.find('.record-link').val(),
                            type: row.find('.record-type').val(),
                            frequency: parseInt(row.find('.record-frequency').val()),
                            tags: row.find('.record-tags').val(),
                            lastPicked: row.data('lastPicked') || null
                        };
                        records.push(record);
                    }
                });
                return records[0];
            }

            // Add Record button handler
            $('#addRecordBtn').click(function() {
                let newRecord = {
                    id: Date.now(), // use timestamp as unique ID
                    selected: false,
                    name: '',
                    link: '',
                    type: 'Review',
                    frequency: 1,
                    tags: '',
                    lastPicked: null
                };
                let row = createRecordRow(newRecord);
                $('#recordsTableBody').append(row);
                // Save data
                saveData();
            });

            // Bulk Delete Handler
            $('#bulkDeleteBtn').click(function() {
                let selectedRows = $('#recordsTableBody .record-select:checked').closest('tr');
                if (selectedRows.length === 0) {
                    alert('No records selected for deletion.');
                    return;
                }
                if (confirm('Are you sure you want to delete the selected records?')) {
                    selectedRows.remove();
                    saveData();
                }
            });

            // Select All Checkbox Handler
            $('#selectAllCheckbox').change(function() {
                let isChecked = $(this).is(':checked');
                $('.record-select').prop('checked', isChecked);
            });

            // Roll button handler
            $('#rollBtn').click(function() {
                let data = getCurrentData();
                let checkedRecords = data.records.filter(record => record.selected);

                if (checkedRecords.length === 0) {
                    alert('No records selected.');
                    return;
                }

                // Separate checked records into Review and Generator types
                let reviewRecords = checkedRecords.filter(record => record.type === 'Review');
                let generatorRecords = checkedRecords.filter(record => record.type === 'Generator');

                let selectedRecord;
                let selectedType;

                if (reviewRecords.length === 0) {
                    // Only generator records are selected
                    selectedType = 'Generator';
                    selectedRecord = pickRecord(generatorRecords);
                } else if (generatorRecords.length === 0) {
                    // Only review records are selected
                    selectedType = 'Review';
                    selectedRecord = pickRecord(reviewRecords);
                } else {
                    // Both types are present, factor in their probabilities
                    let reviewPercent = parseInt($('#typeSlider').val());
                    let generatorPercent = 100 - reviewPercent;

                    let typeRoll = getSecureRandomNumber() * 100;
                    if (typeRoll < reviewPercent) {
                        // Pick from reviewRecords
                        selectedType = 'Review';
                        selectedRecord = pickRecord(reviewRecords);
                    } else {
                        // Pick from generatorRecords
                        selectedType = 'Generator';
                        selectedRecord = pickRecord(generatorRecords);
                    }
                }

                if (selectedRecord) {
                    // Show lottery animation
                    showLotteryAnimation(selectedRecord.name, selectedRecord.link, selectedType);
                }
            });

            // Function to pick a record based on frequency
            function pickRecord(records) {
                // Calculate total weight
                let totalWeight = records.reduce(function(sum, record) {
                    return sum + (record.frequency || 1);
                }, 0);
                // Generate a random number between 0 and totalWeight
                let randomNum = getSecureRandomNumber() * totalWeight;
                let cumulativeWeight = 0;
                for (let i = 0; i < records.length; i++) {
                    cumulativeWeight += records[i].frequency || 1;
                    if (randomNum < cumulativeWeight) {
                        return records[i];
                    }
                }
                return null; // Should not reach here
            }

            // Export State button handler
            $('#exportStateBtn').click(function() {
                let data = getCurrentData();
                let dataStr = JSON.stringify(data, null, 2);
                let blob = new Blob([dataStr], {type: "application/json"});
                let url = URL.createObjectURL(blob);

                let a = document.createElement('a');
                a.href = url;
                a.download = 'ralloc-state.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // After downloading, redirect to the storage destination
                let destination = $('#storageDestination').val();
                if (destination) {
                    window.open(destination, '_blank');
                }
            });

            // Import State button handler
            $('#importStateBtn').click(function() {
                $('#importFileInput').click();
            });

            // File input change handler
            $('#importFileInput').on('change', function(event) {
                let file = event.target.files[0];
                if (!file) {
                    return;
                }
                let reader = new FileReader();
                reader.onload = function(e) {
                    let content = e.target.result;
                    try {
                        let data = JSON.parse(content);
                        // Validate data structure
                        if (!data.records || !Array.isArray(data.records)) {
                            throw new Error('Invalid data structure.');
                        }
                        // Save to LocalStorage
                        localStorage.setItem('rallocStorageKey', JSON.stringify(data));
                        // Reload the page
                        location.reload();
                    } catch (error) {
                        alert('Invalid JSON file.');
                    }
                };
                reader.readAsText(file);
            });

            // Reset State button handler
            $('#resetStateBtn').click(function() {
                if (confirm('Are you sure you want to reset the state? This action cannot be undone.')) {
                    localStorage.removeItem('rallocStorageKey');
                    location.reload();
                }
            });

            // Algorithm Buttons Handlers
            $('#smootheningBtn').click(function() {
                // Inverse the frequencies based on total picks
                let data = getCurrentData();
                let topRecords = data.topRecords || [];
                data.records.forEach(function(record) {
                    let recordStat = topRecords.find(r => r.id === record.id);
                    let totalCount = recordStat ? recordStat.totalCount : 0;
                    record.frequency = Math.max(Math.floor(100 / (totalCount + 1)), 1);
                    record.selected = true;
                });
                data.sliderValue = 50;
                applyDataToUI(data);
                saveData();
            });

            $('#solidifyingBtn').click(function() {
                // Increase frequency of records with fewer Generator picks
                let data = getCurrentData();
                let topRecords = data.topRecords || [];
                data.records.forEach(function(record) {
                    let recordStat = topRecords.find(r => r.id === record.id);
                    let generatorCount = recordStat ? recordStat.generatorCount || 0 : 0;
                    record.frequency = Math.max(Math.floor(100 / (generatorCount + 1)), 1);
                    record.selected = true;
                });
                data.sliderValue = 30; // Favor Review
                applyDataToUI(data);
                saveData();
            });

            $('#reviewingBtn').click(function() {
                // Focus on records with most Review picks
                let data = getCurrentData();
                let topRecords = data.topRecords || [];
                data.records.forEach(function(record) {
                    let recordStat = topRecords.find(r => r.id === record.id);
                    let reviewCount = recordStat ? recordStat.reviewCount || 0 : 0;
                    record.frequency = reviewCount > 0 ? Math.min(reviewCount * 10, 100) : 1;
                    record.selected = true;
                });
                data.sliderValue = 100; // Exclusively Review
                applyDataToUI(data);
                saveData();
            });

            $('#exploringBtn').click(function() {
                // Focus on new or least picked records
                let data = getCurrentData();
                let topRecords = data.topRecords || [];
                data.records.forEach(function(record) {
                    let recordStat = topRecords.find(r => r.id === record.id);
                    let totalCount = recordStat ? recordStat.totalCount : 0;
                    record.frequency = Math.max(Math.floor(100 / (totalCount + 1)), 1);
                    record.selected = true;
                });
                data.sliderValue = 0; // Exclusively Generator
                applyDataToUI(data);
                saveData();
            });

            $('#randomizingBtn').click(function() {
                // Randomize frequencies and checkboxes
                let data = getCurrentData();
                let hasSelected = false;
                data.records.forEach(function(record) {
                    record.frequency = Math.floor(getSecureRandomNumber() * 100) + 1;
                    record.selected = getSecureRandomNumber() < 0.5;
                    if (record.selected) hasSelected = true;
                });
                if (!hasSelected && data.records.length > 0) {
                    // Ensure at least one record is selected
                    data.records[0].selected = true;
                }
                data.sliderValue = Math.floor(getSecureRandomNumber() * 101);
                applyDataToUI(data);
                saveData();
            });

            // Additional Strategies
            $('#spacedRepetitionBtn').click(function() {
                // Increase frequency for records not recently picked
                let data = getCurrentData();
                let now = Date.now();
                data.records.forEach(function(record) {
                    let lastPicked = record.lastPicked || 0;
                    let daysSincePicked = (now - lastPicked) / (1000 * 60 * 60 * 24);
                    record.frequency = Math.min(Math.floor(daysSincePicked * 10), 100);
                    record.selected = true;
                });
                data.sliderValue = 50;
                applyDataToUI(data);
                saveData();
            });

            $('#focusWeakestBtn').click(function() {
                // Focus on records with fewest total picks
                let data = getCurrentData();
                let topRecords = data.topRecords || [];
                data.records.forEach(function(record) {
                    let recordStat = topRecords.find(r => r.id === record.id);
                    let totalCount = recordStat ? recordStat.totalCount : 0;
                    record.frequency = Math.max(Math.floor(100 / (totalCount + 1)), 1);
                    record.selected = true;
                });
                data.sliderValue = 50;
                applyDataToUI(data);
                saveData();
            });

            // Function to apply data to UI (used in algorithm buttons)
            function applyDataToUI(data) {
                // Update slider
                $('#typeSlider').val(data.sliderValue);
                $('#typeSlider').trigger('change');
                // Update records
                $('#recordsTableBody tr').each(function() {
                    let row = $(this);
                    let recordId = row.data('recordId');
                    let record = data.records.find(r => r.id === recordId);
                    if (record) {
                        row.find('.record-select').prop('checked', record.selected);
                        row.find('.record-frequency').val(record.frequency);
                        row.find('.record-frequency').trigger('change');
                        row.find('.record-name').val(record.name);
                        row.find('.record-tags').val(record.tags);
                    }
                });
            }

            // Configuration Section Handlers
            $('#editDestinationBtn').click(function() {
                $('#storageDestination').prop('disabled', false);
                $('#editDestinationBtn').hide();
                $('#saveDestinationBtn, #cancelDestinationBtn').show();
            });

            $('#saveDestinationBtn').click(function() {
                // Validate URL
                let url = $('#storageDestination').val();
                if (!isValidURL(url)) {
                    alert('Please enter a valid URL.');
                    return;
                }
                $('#storageDestination').prop('disabled', true);
                $('#editDestinationBtn').show();
                $('#saveDestinationBtn, #cancelDestinationBtn').hide();
                saveData();
            });

            $('#cancelDestinationBtn').click(function() {
                $('#storageDestination').prop('disabled', true);
                $('#editDestinationBtn').show();
                $('#saveDestinationBtn, #cancelDestinationBtn').hide();
                // Reload the value from localStorage
                let data = JSON.parse(localStorage.getItem('rallocStorageKey') || '{}');
                $('#storageDestination').val(data.storageDestination || defaultStorageDestination);
            });

            // Function to validate URL
            function isValidURL(string) {
                var res = string.match(/(http|https):\/\/(\w+:?\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/);
                return (res !== null)
            };

            // Function to show lottery animation
            function showLotteryAnimation(recordName, recordLink, selectedType) {
                $('#animationRecordName').text(recordName || 'Unknown');
                let animationDiv = $('#lotteryAnimation');
                let overlayDiv = $('#overlay');
                animationDiv.removeClass('hide').addClass('show');
                overlayDiv.show();

                // Duration of the animation (e.g., 4 seconds)
                let animationDuration = 4000; // milliseconds

                // After animation completes, hide the animation and open the link
                setTimeout(function() {
                    animationDiv.removeClass('show').addClass('hide');
                    // Hide the animation after fade out
                    setTimeout(function() {
                        animationDiv.removeClass('hide');
                        $('#animationRecordName').text('');
                        overlayDiv.hide();
                        // Open the link after animation
                        window.open(recordLink, '_blank');
                        // Proceed with updating records
                        proceedAfterRoll(recordLink, selectedType);
                    }, 500); // Match fadeOut duration
                }, animationDuration);
            }

            // Function to proceed with updating records after animation
            function proceedAfterRoll(recordLink, selectedType) {
                let data = getCurrentData();
                let selectedRecord = data.records.find(record => record.link === recordLink);
                if (!selectedRecord) return;

                // Update the topRecords
                let topRecords = data.topRecords || [];
                let recordStat = topRecords.find(r => r.id === selectedRecord.id);
                if (recordStat) {
                    recordStat.totalCount += 1;
                    if (selectedType === 'Review') {
                        recordStat.reviewCount = (recordStat.reviewCount || 0) + 1;
                    } else {
                        recordStat.generatorCount = (recordStat.generatorCount || 0) + 1;
                    }
                } else {
                    let newRecordStat = {
                        id: selectedRecord.id,
                        totalCount: 1,
                        reviewCount: selectedType === 'Review' ? 1 : 0,
                        generatorCount: selectedType === 'Generator' ? 1 : 0
                    };
                    topRecords.push(newRecordStat);
                }
                totalRolls += 1;
                if (selectedType === 'Review') {
                    totalReviewRolls += 1;
                } else {
                    totalGeneratorRolls += 1;
                }

                // Update user level based on totalRolls
                let newLevel = Math.floor(totalRolls / rollsForNextLevel) + 1;
                if (newLevel > userLevel) {
                    userLevel = newLevel;
                    rollsForNextLevel = calculateRollsForNextLevel(userLevel);
                    alert('Congratulations! You have reached Level ' + userLevel + '!');
                }

                // Update lastPicked
                let row = $('#recordsTableBody tr').filter(function() {
                    return $(this).data('recordId') === selectedRecord.id;
                });
                row.data('lastPicked', Date.now());

                // Save topRecords, totalRolls, and userLevel to data and LocalStorage
                data.topRecords = topRecords;
                data.totalRolls = totalRolls;
                data.totalReviewRolls = totalReviewRolls;
                data.totalGeneratorRolls = totalGeneratorRolls;
                data.userLevel = userLevel;
                localStorage.setItem('rallocStorageKey', JSON.stringify(data));

                // Update the top records list and chart
                populateTopRecords(topRecords);

                // Update gamification UI
                updateGamificationUI();
            }

            // Search and Filter Handler
            $('#searchBar').on('input', function() {
                let query = $(this).val().toLowerCase();
                $('#recordsTableBody tr').each(function() {
                    let row = $(this);
                    let name = row.find('.record-name').val().toLowerCase();
                    let type = row.find('.record-type').val().toLowerCase();
                    let tags = row.find('.record-tags').val().toLowerCase();
                    if (name.includes(query) || type.includes(query) || tags.includes(query)) {
                        row.show();
                    } else {
                        row.hide();
                    }
                });
            });

        });
    </script>
</body>
</html>
