<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <title>stash5 · Issue Launcher + Leaderboard</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <style>
    :root{
      --bg:#0d1117; --panel:#161b22; --text:#c9d1d9; --muted:#8b949e; --accent:#2f81f7; --border:#30363d;
    }
    body{background:var(--bg); color:var(--text);}
    a, .btn{color:var(--text);}
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      color:var(--text);
    }
    .card:hover{border-color:var(--accent);}
    .badge { background: var(--panel); border: 1px solid var(--border); color: var(--text); }
    .list-group-item{
      background:var(--panel);
      color:var(--text);
      border-color:var(--border);
    }
    .nav-pills .nav-link{background:var(--panel); border:1px solid var(--border); color:var(--text);}
    .nav-pills .nav-link:hover{border-color:var(--accent);}
    .muted{color:var(--muted);}
    .tile-title{font-weight:600;}
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Header -->
    <div class="row mb-3">
      <div class="col-12 col-lg-8">
        <h1 class="h4 mb-1">stash5 · Issue Launcher</h1>
        <p class="muted mb-0">Tap a tile to open a new GitHub issue with the selected template. Your clicks power the leaderboard (stored locally via IndexedDB).</p>
      </div>
      <div class="col-12 col-lg-4 mt-3 mt-lg-0 d-flex align-items-start justify-content-lg-end gap-2">
        <a class="btn btn-sm" href="https://github.com/sktoushi/stash5" target="_blank" rel="noopener noreferrer">Repo</a>
        <button id="resetCounts" class="btn btn-sm">Reset Leaderboard</button>
      </div>
    </div>

    <!-- Quick Label Searches -->
    <div class="row mb-4">
      <div class="col-12">
        <ul class="nav nav-pills flex-wrap gap-2">
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22goodDecision1%22" target="_blank" rel="noopener">#goodDecision1</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22goodDecision2%22" target="_blank" rel="noopener">#goodDecision2</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22goodDecision3%22" target="_blank" rel="noopener">#goodDecision3</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22forcedDecision1%22" target="_blank" rel="noopener">#forcedDecision1</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22forcedDecision2%22" target="_blank" rel="noopener">#forcedDecision2</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22forcedDecision3%22" target="_blank" rel="noopener">#forcedDecision3</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22badDecision1%22" target="_blank" rel="noopener">#badDecision1</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22badDecision2%22" target="_blank" rel="noopener">#badDecision2</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22badDecision3%22" target="_blank" rel="noopener">#badDecision3</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-2" href="https://github.com/sktoushi/stash5/issues?q=is%3Aissue+label%3A%22decision%22" target="_blank" rel="noopener">#decision</a></li>
        </ul>
      </div>
    </div>

    <div class="row g-3">
      <!-- Grid (mobile: 1 col, md: 2 cols, lg+: 3 cols) -->
      <!-- Good -->
      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="goodDecision1" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-goodDecision1.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Good Decision 1</span>
              <span class="badge rounded-pill" id="count-goodDecision1">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="goodDecision2" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-goodDecision2.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Good Decision 2</span>
              <span class="badge rounded-pill" id="count-goodDecision2">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="goodDecision3" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-goodDecision3.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Good Decision 3</span>
              <span class="badge rounded-pill" id="count-goodDecision3">0</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Forced -->
      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="forcedDecision1" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-forcedDecision1.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Forced Decision 1</span>
              <span class="badge rounded-pill" id="count-forcedDecision1">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="forcedDecision2" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-forcedDecision2.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Forced Decision 2</span>
              <span class="badge rounded-pill" id="count-forcedDecision2">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="forcedDecision3" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-forcedDecision3.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Forced Decision 3</span>
              <span class="badge rounded-pill" id="count-forcedDecision3">0</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Bad -->
      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="badDecision1" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-badDecision1.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Bad Decision 1</span>
              <span class="badge rounded-pill" id="count-badDecision1">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="badDecision2" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-badDecision2.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Bad Decision 2</span>
              <span class="badge rounded-pill" id="count-badDecision2">0</span>
            </div>
          </div>
        </a>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <a class="text-decoration-none tile" data-id="badDecision3" href="https://github.com/sktoushi/stash5/issues/new?template=real-life-badDecision3.md" target="_blank" rel="noopener">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
              <span class="tile-title">Bad Decision 3</span>
              <span class="badge rounded-pill" id="count-badDecision3">0</span>
            </div>
          </div>
        </a>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="row mt-4">
      <div class="col-12 col-lg-6">
        <h2 class="h5 mb-2">Leaderboard</h2>
        <ul id="leaderboard" class="list-group"></ul>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS (optional, for better focus states) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <script>
    // ---- Config ----
    const TILES = [
      { id: "goodDecision1",  title: "Good Decision 1"  },
      { id: "goodDecision2",  title: "Good Decision 2"  },
      { id: "goodDecision3",  title: "Good Decision 3"  },
      { id: "forcedDecision1",title: "Forced Decision 1"},
      { id: "forcedDecision2",title: "Forced Decision 2"},
      { id: "forcedDecision3",title: "Forced Decision 3"},
      { id: "badDecision1",   title: "Bad Decision 1"   },
      { id: "badDecision2",   title: "Bad Decision 2"   },
      { id: "badDecision3",   title: "Bad Decision 3"   },
    ];

    // ---- Minimal IndexedDB helper ----
    const DB_NAME = "stash5-issue-launcher";
    const STORE = "clicks";
    const DB_VERSION = 1;

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE)){
            const store = db.createObjectStore(STORE, { keyPath: "id" });
            // Seed with zero counts
            TILES.forEach(t => store.add({ id: t.id, title: t.title, count: 0 }));
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function getAllCounts(db){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const store = tx.objectStore(STORE);
        const req = store.getAll();
        req.onsuccess = () => {
          // Ensure all entries exist (helps if schema created before list changed)
          const have = new Map(req.result.map(r => [r.id, r]));
          const merged = TILES.map(t => have.get(t.id) ?? { id: t.id, title: t.title, count: 0 });
          resolve(merged);
        };
        req.onerror = () => reject(req.error);
      });
    }

    async function incrementCount(db, id){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        const getReq = store.get(id);
        getReq.onsuccess = () => {
          const rec = getReq.result || { id, title: (TILES.find(t=>t.id===id)?.title || id), count: 0 };
          rec.count = (rec.count || 0) + 1;
          const putReq = store.put(rec);
          putReq.onsuccess = () => resolve(rec);
          putReq.onerror = () => reject(putReq.error);
        };
        getReq.onerror = () => reject(getReq.error);
      });
    }

    // ---- UI helpers ----
    function renderBadges(counts){
      counts.forEach(({id, count}) => {
        const el = document.getElementById(`count-${id}`);
        if(el) el.textContent = count;
      });
    }

    function renderLeaderboard(counts){
      // Sort by count desc, then title asc
      const sorted = [...counts].sort((a,b) => {
        if(b.count !== a.count) return b.count - a.count;
        return a.title.localeCompare(b.title);
      });
      const ul = document.getElementById("leaderboard");
      ul.innerHTML = "";
      sorted.forEach(({id, title, count}, idx) => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex align-items-center justify-content-between";
        li.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <span class="badge rounded-pill">${idx + 1}</span>
            <span>${title}</span>
          </div>
          <span class="badge rounded-pill">${count}</span>
        `;
        ul.appendChild(li);
      });
    }

    async function refreshUI(db){
      const rows = await getAllCounts(db);
      renderBadges(rows);
      renderLeaderboard(rows);
    }

    // ---- Init ----
    (async function init(){
      const db = await openDB();

      // Ensure all tiles exist (if list changed after first run)
      // (Runs silently: adds missing records with count 0)
      const existing = await getAllCounts(db);
      const existingIds = new Set(existing.map(r => r.id));
      const missing = TILES.filter(t => !existingIds.has(t.id));
      if(missing.length){
        const tx = db.transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        missing.forEach(t => store.put({ id: t.id, title: t.title, count: 0 }));
      }

      await refreshUI(db);

      // Click handling: increment count before navigating.
      document.querySelectorAll(".tile").forEach(anchor => {
        anchor.addEventListener("click", async (ev) => {
          // Try to ensure increment lands before navigation:
          ev.preventDefault();
          const id = anchor.getAttribute("data-id");
          try {
            await incrementCount(db, id);
          } catch(e){
            // no-op; we'll navigate regardless
          }
          await refreshUI(db);

          // Navigate (open in new tab if target set)
          const url = anchor.getAttribute("href");
          const target = anchor.getAttribute("target");
          if(target === "_blank"){
            window.open(url, "_blank", "noopener");
          } else {
            location.href = url;
          }
        }, { passive: false });
      });

      // Reset
      document.getElementById("resetCounts").addEventListener("click", async () => {
        const confirmed = confirm("Reset local leaderboard counts? This only affects your browser.");
        if(!confirmed) return;
        const tx = (await openDB()).transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        const resetPromises = TILES.map(t => new Promise((res, rej) => {
          const req = store.put({ id: t.id, title: t.title, count: 0 });
          req.onsuccess = () => res();
          req.onerror = () => rej(req.error);
        }));
        await Promise.allSettled(resetPromises);
        await refreshUI(await openDB());
      });
    })();
  </script>
</body>
</html>
